#!/bin/bash
# Compilation and execution on Git-Bash (GNU C Compiler)
set -e

OFLAGS="-Ofast -march=native -mtune=native -funroll-all-loops"

while [[ $1 != "" ]]; do
    case $1 in
    --test)
        # Use --test to cut measurement interval to 1 second (from 5 as is used
        # in Dave's standard benchmark) and set some compile warnings.
        SFLAGS="--secs 1"
        TFLAGS="-Wall"
        TEST=1
        ;;
    
    --debug)
        OFLAGS="-ggdb"
        DEBUG=1
        ;;

    *)
        echo "Unknown flag: $1"
        exit 1
        ;;
    esac

    shift
done

echo Compiling with flags: $OFLAGS

gcc $TFLAGS $OFLAGS -pthread par-sieve.c -o par-sieve
gcc $TFLAGS $OFLAGS sieve.c -o sieve

if [[ $DEBUG ]]; then
    gdb ./par-sieve
    exit 0
fi

if [[ $TEST ]]; then
    for info in "model name" "cpu MHz" "cache size"
    do
        grep -m1 "$info" /proc/cpuinfo
    done

    ./sieve $SFLAGS
    echo

    ./par-sieve $SFLAGS --show-work --threads 1
    for threads in {2..16}
    do
        ./par-sieve $SFLAGS --show-work --threads $threads | grep "per pass\|Scan"
    done
else
    ./sieve $SFLAGS
    echo
    ./par-sieve $SFLAGS
fi
