name: Benchmark

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  python:
    runs-on: ubuntu-latest

    outputs:
      result: ${{ steps.benchmark.outputs.result }}

    steps:
      - uses: actions/checkout@v2
      - name: Set up Python 3.9
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Benchmark
        id: benchmark
        working-directory: PrimeSievePY
        run: echo ::set-output name=result::$(python3 PrimePY.py)

  pypy:
    runs-on: ubuntu-latest

    outputs:
      result: ${{ steps.benchmark.outputs.result }}

    steps:
      - uses: actions/checkout@v2
      - name: Set up PyPy 3.7
        uses: actions/setup-python@v2
        with:
          python-version: pypy-3.7
      - name: Benchmark
        id: benchmark
        working-directory: PrimeSievePY
        run: echo ::set-output name=result::$(pypy PrimePY.py)

  cpp:
    runs-on: ubuntu-latest

    outputs:
      result: ${{ steps.benchmark.outputs.result }}

    steps:
      - uses: actions/checkout@v2
      - name: Benchmark
        id: benchmark
        working-directory: PrimeCPP
        run: echo ::set-output name=result::$(./run.sh)

  csharp:
    runs-on: ubuntu-latest

    outputs:
      result: ${{ steps.benchmark.outputs.result }}

    steps:
      - uses: actions/checkout@v2
      - name: Set up .Net Core 3.1
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: "3.1.x"
      - name: Benchmark
        id: benchmark
        working-directory: PrimeSieveCS
        run: echo ::set-output name=result::$(dotnet run)

  output:
    runs-on: ubuntu-latest

    needs:
      - python
      - pypy
      - cpp
      - csharp

    steps:
      - name: Create commit comment
        uses: peter-evans/commit-comment@v1
        with:
          body: |
            ## Benchmark
            | Language | Result                             |
            | ---------|------------------------------------|
            | Python   | ${{ needs.python.outputs.result }} |
            | PyPy     | ${{ needs.pypy.outputs.result }}   |
            | C++      | ${{ needs.cpp.outputs.result }}    |
            | C#       | ${{ needs.csharp.outputs.result }} |
